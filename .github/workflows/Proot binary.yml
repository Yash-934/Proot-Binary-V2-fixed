name: Build Android-Compatible PRoot (Termux Style)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      proot_version:
        description: 'PRoot version/commit'
        required: true
        default: '5.1.107'
      termux_commit:
        description: 'Termux proot commit hash'
        required: true
        default: '228a5f28b078f4e2504de46758ce17948f73f507'

jobs:
  build-android-aarch64:
    runs-on: ubuntu-latest
    name: Build Android PRoot (Termux Style) - AArch64
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: android-actions/setup-android@v2
      with:
        ndk-version: r25c  # Termux compatible NDK version

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          tar \
          file \
          git \
          make \
          python3 \
          bison \
          flex \
          libtalloc-dev \
          crossbuild-essential-arm64

    - name: Setup Termux Build Environment
      run: |
        # Create Termux-style build directory
        export TERMUX_TOPDIR=$HOME/.termux-build
        mkdir -p $TERMUX_TOPDIR
        
        # Setup NDK toolchain (Termux style)
        export NDK=$ANDROID_SDK_ROOT/ndk/25.2.9519653  # r25c
        
        # Create standalone toolchain (Termux method)
        $NDK/build/tools/make_standalone_toolchain.py \
          --arch arm64 \
          --api 24 \
          --install-dir=$TERMUX_TOPDIR/toolchain-aarch64 \
          || $NDK/build/tools/make_standalone_toolchain.py \
          --arch arm64 \
          --api 21 \
          --install-dir=$TERMUX_TOPDIR/toolchain-aarch64

    - name: Clone Termux PRoot Source
      run: |
        export TERMUX_TOPDIR=$HOME/.termux-build
        
        # Clone Termux fork (not upstream!)
        # Termux uses their own fork with Android patches
        git clone --depth 1 \
          https://github.com/termux/proot.git \
          $TERMUX_TOPDIR/proot/src
        
        cd $TERMUX_TOPDIR/proot/src
        
        # Checkout specific stable commit (Termux style)
        # This is the commit Termux actually uses
        git fetch --depth=1 origin 228a5f28b078f4e2504de46758ce17948f73f507
        git checkout 228a5f28b078f4e2504de46758ce17948f73f507

    - name: Apply Termux Patches & Build
      run: |
        export TERMUX_TOPDIR=$HOME/.termux-build
        export PATH=$TERMUX_TOPDIR/toolchain-aarch64/bin:$PATH
        
        cd $TERMUX_TOPDIR/proot/src
        
        # Set Termux-style environment variables
        export CC=aarch64-linux-android21-clang
        export CXX=aarch64-linux-android21-clang++
        export AR=aarch64-linux-android-ar
        export STRIP=aarch64-linux-android-strip
        
        # Termux specific: Set sysroot and flags
        export SYSROOT=$TERMUX_TOPDIR/toolchain-aarch64/sysroot
        export CFLAGS="-fPIC -fPIE -pie --sysroot=$SYSROOT -I$SYSROOT/usr/include"
        export LDFLAGS="-L$SYSROOT/usr/lib -ltalloc -pie"
        
        # Termux pre-configure step (from their build.sh)
        export CPPFLAGS="-DARG_MAX=131072"
        
        # Termux build style: Unbundle loader
        export PROOT_UNBUNDLE_LOADER=1
        
        # Clean build
        make -C src clean
        
        # Build loader first (Termux style)
        make -C src loader.elf build.h
        
        # Build proot binary
        make -C src proot
        
        # Verify PIE (Position Independent Executable)
        file src/proot
        
        # Check if it's actually PIE
        if readelf -h src/proot | grep -q "DYN"; then
          echo "‚úì Binary is PIE (Position Independent Executable)"
        else
          echo "‚ö† Warning: Binary may not be PIE"
        fi

    - name: Prepare Android Binary
      run: |
        mkdir -p $HOME/android-proot-release
        
        # Copy binaries
        cp $HOME/.termux-build/proot/src/src/proot \
           $HOME/android-proot-release/proot-android-aarch64
        
        cp $HOME/.termux-build/proot/src/src/loader/loader \
           $HOME/android-proot-release/loader
        
        # Create wrapper script (Termux style)
        cat > $HOME/android-proot-release/proot-wrapper.sh << 'EOF'
        #!/system/bin/sh
        # Android PRoot Wrapper
        # Usage: ./proot-wrapper.sh [proot-args]
        
        PROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
        export PROOT_LOADER="$PROOT_DIR/loader"
        
        exec "$PROOT_DIR/proot-android-aarch64" "$@"
        EOF
        
        chmod +x $HOME/android-proot-release/proot-wrapper.sh
        chmod +x $HOME/android-proot-release/proot-android-aarch64
        
        # Create README
        cat > $HOME/android-proot-release/README.txt << EOF
        Android-Compatible PRoot Binary (Termux Style)
        ================================================
        
        Version: Termux commit 228a5f28
        Architecture: aarch64/arm64
        Target: Android API 21+ (Android 5.0+)
        
        Files:
        - proot-android-aarch64: Main binary (PIE)
        - loader: Loader helper
        - proot-wrapper.sh: Wrapper script for Android
        
        Usage on Android:
        1. Push to device: adb push proot-android-aarch64 /data/local/tmp/
        2. Make executable: chmod +x /data/local/tmp/proot-android-aarch64
        3. Run: /data/local/tmp/proot-android-aarch64 -r /path/to/rootfs /bin/sh
        
        Or use wrapper:
        ./proot-wrapper.sh -r /path/to/rootfs /bin/sh
        
        Notes:
        - This is PIE (Position Independent Executable) for Android compatibility
        - Built with Android NDK r25c
        - Uses Termux patches and build logic
        - No static linking (uses system talloc)
        
        Build Date: $(date)
        EOF

    - name: Upload Android Binary
      uses: actions/upload-artifact@v4
      with:
        name: proot-android-aarch64-termux-style
        path: |
          ~/android-proot-release/proot-android-aarch64
          ~/android-proot-release/loader
          ~/android-proot-release/proot-wrapper.sh
          ~/android-proot-release/README.txt
        if-no-files-found: error

  build-android-armv7:
    runs-on: ubuntu-latest
    name: Build Android PRoot - ARMv7
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: android-actions/setup-android@v2
      with:
        ndk-version: r25c

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget tar file git make python3 crossbuild-essential-armhf

    - name: Build ARMv7 Binary
      run: |
        export NDK=$ANDROID_SDK_ROOT/ndk/25.2.9519653
        
        # Create standalone toolchain for ARMv7
        $NDK/build/tools/make_standalone_toolchain.py \
          --arch arm \
          --api 21 \
          --install-dir=$HOME/toolchain-armv7
        
        # Clone Termux proot
        git clone --depth 1 https://github.com/termux/proot.git $HOME/proot-armv7
        cd $HOME/proot-armv7
        
        # Checkout stable commit
        git fetch --depth=1 origin 228a5f28b078f4e2504de46758ce17948f73f507
        git checkout 228a5f28b078f4e2504de46758ce17948f73f507
        
        # Setup ARMv7 cross-compile
        export PATH=$HOME/toolchain-armv7/bin:$PATH
        export CC=arm-linux-androideabi-clang
        export CXX=arm-linux-androideabi-clang++
        export AR=arm-linux-androideabi-ar
        export SYSROOT=$HOME/toolchain-armv7/sysroot
        export CFLAGS="-fPIC -fPIE -pie --sysroot=$SYSROOT"
        export LDFLAGS="-ltalloc -pie"
        export CPPFLAGS="-DARG_MAX=131072"
        export PROOT_UNBUNDLE_LOADER=1
        
        # Build
        make -C src clean
        make -C src loader.elf build.h
        make -C src proot
        
        # Prepare output
        mkdir -p $HOME/android-proot-release-armv7
        cp src/proot $HOME/android-proot-release-armv7/proot-android-armv7
        cp src/loader/loader $HOME/android-proot-release-armv7/loader

    - name: Upload ARMv7 Binary
      uses: actions/upload-artifact@v4
      with:
        name: proot-android-armv7
        path: ~/android-proot-release-armv7/*

  release:
    needs: [build-android-aarch64, build-android-armv7]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: proot-android-*

    - name: Prepare Release Assets
      run: |
        mkdir -p release
        
        # Copy and rename
        cp artifacts/proot-android-aarch64-termux-style/proot-android-aarch64 release/
        cp artifacts/proot-android-aarch64-termux-style/loader release/loader-aarch64
        cp artifacts/proot-android-armv7/proot-android-armv7 release/
        cp artifacts/proot-android-armv7/loader release/loader-armv7
        
        # Create wrapper scripts
        for arch in aarch64 armv7; do
          cat > release/proot-wrapper-${arch}.sh << EOF
        #!/system/bin/sh
        PROOT_DIR="\$(cd "\$(dirname "\$0")" && pwd)"
        export PROOT_LOADER="\$PROOT_DIR/loader-${arch}"
        exec "\$PROOT_DIR/proot-android-${arch}" "\$@"
        EOF
          chmod +x release/proot-wrapper-${arch}.sh
        done
        
        # Create tar.gz archives
        cd release
        for f in proot-android-*; do
          arch=$(echo $f | sed 's/proot-android-//')
          tar -czf "proot-android-${arch}-termux-style.tar.gz" \
            proot-android-${arch} \
            loader-${arch} \
            proot-wrapper-${arch}.sh \
            README.txt 2>/dev/null || true
        done

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*.tar.gz
        body: |
          ## Android-Compatible PRoot (Termux Style)
          
          ### üéØ What's Special?
          - Built using **Termux build logic** and patches
          - **PIE (Position Independent Executable)** - Required for Android 5.0+
          - **NDK r25c** toolchain
          - **Unbundled loader** (Termux style)
          
          ### üì¶ Files
          - `proot-android-aarch64` - Main binary for modern Android devices
          - `proot-android-armv7` - For older 32-bit ARM devices
          - `loader-*` - Helper loader files
          - `proot-wrapper-*.sh` - Convenient wrapper scripts
          
          ### üöÄ Quick Start
          ```bash
          # Push to Android device
          adb push proot-android-aarch64 /data/local/tmp/
          adb push loader-aarch64 /data/local/tmp/
          
          # Execute
          adb shell chmod +x /data/local/tmp/proot-android-aarch64
          adb shell /data/local/tmp/proot-android-aarch64 -r /data/local/tmp/rootfs /bin/sh
          ```
          
          ### üîß Technical Details
          - **Source**: termux/proot (fork with Android patches)
          - **Commit**: 228a5f28b078f4e2504de46758ce17948f73f507
          - **Build**: GitHub Actions with Android NDK
          - **Target**: Android API 21+ (Android 5.0+)
          - **Type**: DYN (PIE), not EXEC
          
          ### ‚ö†Ô∏è Important
          - These binaries are **NOT fully static** (use system talloc)
          - They are **PIE** for Android compatibility
          - Use wrapper script or set `PROOT_LOADER` environment variable
          
          ### üôè Credits
          - Termux team for Android patches and build system
          - PRoot original authors
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
