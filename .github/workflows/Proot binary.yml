name: Build Android PRoot (Correct Termux Method)

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android-aarch64:
    runs-on: ubuntu-latest
    name: Build Android PRoot - AArch64 (Correct Method)
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        add-to-path: true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget file git make python3 bison flex libtalloc-dev

    - name: Clone Termux PRoot Source
      run: |
        # Clone Termux fork
        git clone --depth 1 \
          https://github.com/termux/proot.git \
          $HOME/proot-src
        
        cd $HOME/proot-src
        
        # Checkout stable commit
        git fetch --depth=1 origin 228a5f28b078f4e2504de46758ce17948f73f507
        git checkout 228a5f28b078f4e2504de46758ce17948f73f507

    - name: Build with Modern NDK (Correct Method)
      run: |
        cd $HOME/proot-src
        
        # Modern NDK toolchain
        export NDK=$ANDROID_NDK_HOME
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export CC=$TOOLCHAIN/bin/aarch64-linux-android21-clang
        export CXX=$TOOLCHAIN/bin/aarch64-linux-android21-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        export STRIP=$TOOLCHAIN/bin/llvm-strip
        
        # Termux-style flags
        export CFLAGS="-fPIC -fPIE -pie -O2"
        export LDFLAGS="-pie -ltalloc"
        export CPPFLAGS="-DARG_MAX=131072"
        
        # Unbundle loader (Termux style)
        export PROOT_UNBUNDLE_LOADER=1
        
        # Clean
        make -C src clean
        
        # Build proot directly (NO loader.elf step needed!)
        # Termux mein directly 'make -C src' se proot banta hai
        make -C src
        
        # Build loader separately (Termux style)
        make -C loader
        
        # Verify
        file src/proot
        file loader/loader

    - name: Prepare Android Binary
      run: |
        mkdir -p $HOME/android-proot-release
        
        # Copy binaries (Termux style paths)
        cp $HOME/proot-src/src/proot \
           $HOME/android-proot-release/proot-android-aarch64
        
        cp $HOME/proot-src/loader/loader \
           $HOME/android-proot-release/loader-aarch64
        
        # Create wrapper script
        cat > $HOME/android-proot-release/proot-wrapper.sh << 'EOF'
        #!/system/bin/sh
        PROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
        export PROOT_LOADER="$PROOT_DIR/loader-aarch64"
        exec "$PROOT_DIR/proot-android-aarch64" "$@"
        EOF
        
        chmod +x $HOME/android-proot-release/proot-wrapper.sh
        chmod +x $HOME/android-proot-release/proot-android-aarch64
        
        # Create README
        cat > $HOME/android-proot-release/README.txt << EOF
        Android PRoot Binary (Correct Termux Method)
        ==============================================
        
        Version: Termux commit 228a5f28
        Architecture: aarch64/arm64
        Target: Android API 21+
        
        Files:
        - proot-android-aarch64: Main PIE binary
        - loader-aarch64: Loader helper
        - proot-wrapper.sh: Wrapper script
        
        Usage:
        ./proot-wrapper.sh -r /path/to/rootfs /bin/sh
        
        Build Date: $(date)
        EOF

    - name: Upload Android Binary
      uses: actions/upload-artifact@v4
      with:
        name: proot-android-aarch64-correct
        path: |
          ~/android-proot-release/proot-android-aarch64
          ~/android-proot-release/loader-aarch64
          ~/android-proot-release/proot-wrapper.sh
          ~/android-proot-release/README.txt
        if-no-files-found: error

  build-android-armv7:
    runs-on: ubuntu-latest
    name: Build Android PRoot - ARMv7
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        add-to-path: true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget file git make python3 bison flex libtalloc-dev

    - name: Build ARMv7 Binary
      run: |
        git clone --depth 1 https://github.com/termux/proot.git $HOME/proot-armv7
        cd $HOME/proot-armv7
        git fetch --depth=1 origin 228a5f28b078f4e2504de46758ce17948f73f507
        git checkout 228a5f28b078f4e2504de46758ce17948f73f507
        
        export NDK=$ANDROID_NDK_HOME
        export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
        export CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang
        export CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        
        export CFLAGS="-fPIC -fPIE -pie -O2"
        export LDFLAGS="-pie -ltalloc"
        export CPPFLAGS="-DARG_MAX=131072"
        export PROOT_UNBUNDLE_LOADER=1
        
        make -C src clean
        make -C src
        make -C loader
        
        mkdir -p $HOME/android-proot-armv7
        cp src/proot $HOME/android-proot-armv7/proot-android-armv7
        cp loader/loader $HOME/android-proot-armv7/loader-armv7

    - name: Upload ARMv7 Binary
      uses: actions/upload-artifact@v4
      with:
        name: proot-android-armv7-correct
        path: ~/android-proot-armv7/*
        if-no-files-found: error
